<%# locals: (entry:, balance_trend: nil, view_ctx: "global") %>

<% transaction = entry.entryable %>

<%= turbo_frame_tag dom_id(entry) do %>
  <%= turbo_frame_tag dom_id(transaction) do %>
    <div class="flex lg:grid lg:grid-cols-12 items-center text-primary text-sm font-medium p-3 lg:p-4 <%= entry.excluded ? "opacity-50 text-gray-400" : "" %>">

      <div class="pr-4 lg:pr-10 flex items-center gap-3 lg:gap-4 col-span-8 min-w-0">
        <%= check_box_tag dom_id(entry, "selection"),
            disabled: transaction.transfer.present?,
            class: "checkbox checkbox--light hidden lg:block",
            data: {
              id: entry.id,
              "bulk-select-target": "row",
              action: "bulk-select#toggleRowSelection",
              checkbox_toggle_target: "selectionEntry"
            } %>

        <div class="max-w-full">
          <%= content_tag :div, class: ["flex items-center gap-3 lg:gap-4"] do %>
            <%# Logo - Desktop %>
            <div class="hidden lg:flex shrink-0">
              <% if transaction.merchant&.logo_url.present? %>
                <div data-controller="adaptive-logo" class="w-14 h-14 rounded-[22%] overflow-hidden flex items-center justify-center border-2 border-gray-200 p-1" data-adaptive-logo-target="container">
                  <%= image_tag transaction.merchant.logo_url,
                      class: "w-full h-full object-contain rounded-[18%]",
                      loading: "lazy",
                      data: { adaptive_logo_target: "image" } %>
                </div>
              <% else %>
                <%= render DS::FilledIcon.new(
                  variant: :text,
                  text: entry.name,
                  size: "lg",
                  rounded: false
                ) %>
              <% end %>
            </div>

            <%# Logo - Mobile with category icon %>
            <div class="flex md:hidden items-center gap-1 col-span-2 relative shrink-0">
              <%= render "transactions/transaction_category", transaction: transaction, variant: "mobile" %>
              <% if transaction.merchant&.logo_url.present? %>
                <div data-controller="adaptive-logo" class="w-5 h-5 rounded-[22%] overflow-hidden absolute -bottom-1 -right-1 pointer-events-none border border-gray-200" data-adaptive-logo-target="container">
                  <%= image_tag transaction.merchant.logo_url,
                      class: "w-full h-full object-contain bg-white rounded-[18%]",
                      loading: "lazy",
                      data: { adaptive_logo_target: "image" } %>
                </div>
              <% end %>
            </div>

            <div class="min-w-0 flex-1">
              <div class="space-y-0.5">
                <%# Name and badges on same line %>
                <div class="flex items-center gap-1.5 min-w-0">
                  <div class="truncate flex-shrink min-w-0">
                    <% if transaction.transfer? %>
                      <%= link_to(
                            entry.name,
                            transaction.transfer.present? ? transfer_path(transaction.transfer) : entry_path(entry),
                            data: {
                              turbo_frame: "drawer",
                              turbo_prefetch: false
                            },
                            class: "hover:underline"
                          ) %>
                    <% else %>
                      <%= link_to(
                            entry.name,
                            entry_path(entry),
                            data: {
                              turbo_frame: "drawer",
                              turbo_prefetch: false
                            },
                            class: "hover:underline"
                          ) %>
                    <% end %>
                  </div>

                  <div class="flex items-center gap-1 flex-shrink-0 flex-wrap">
                    <% if transaction.one_time? %>
                      <span class="text-orange-500" title="One-time <%= entry.amount.negative? ? "income" : "expense" %> (excluded from averages)">
                        <%= icon "asterisk", size: "sm", color: "current" %>
                      </span>
                    <% end %>

                    <%# Pending indicator %>
                    <% if transaction.pending? %>
                      <span class="inline-flex items-center gap-1 text-xs font-medium rounded-full px-1.5 py-0.5 border border-secondary text-secondary" title="<%= t("transactions.transaction.pending_tooltip") %>">
                        <%= icon "clock", size: "sm", color: "current" %>
                        <%= t("transactions.transaction.pending") %>
                      </span>
                    <% end %>

                    <%# Investment activity label badge %>
                    <% if transaction.investment_activity_label.present? %>
                      <span class="inline-flex items-center px-1.5 py-0.5 rounded text-xs font-medium bg-alpha-black-50 text-secondary" title="<%= t("transactions.transaction.activity_type_tooltip") %>">
                        <%= t("transactions.activity_labels.#{transaction.investment_activity_label.parameterize(separator: '_')}") %>
                      </span>
                    <% end %>

                    <%# Potential duplicate indicator - different styling for low vs medium confidence %>
                    <% if transaction.has_potential_duplicate? %>
                      <% if transaction.low_confidence_duplicate? %>
                        <span class="inline-flex items-center gap-1 text-xs font-medium rounded-full px-1.5 py-0.5 border border-secondary bg-surface-inset text-secondary" title="<%= t("transactions.transaction.review_recommended_tooltip") %>">
                          <%= icon "help-circle", size: "sm", color: "current" %>
                          <%= t("transactions.transaction.review_recommended") %>
                        </span>
                      <% else %>
                        <span class="inline-flex items-center gap-1 text-xs font-medium rounded-full px-1.5 py-0.5 border border-warning bg-warning/10 text-warning" title="<%= t("transactions.transaction.potential_duplicate_tooltip") %>">
                          <%= icon "alert-triangle", size: "sm", color: "current" %>
                          <%= t("transactions.transaction.possible_duplicate") %>
                        </span>
                      <% end %>
                    <% end %>

                    <% if transaction.transfer.present? %>
                      <%= render "transactions/transfer_match", transaction: transaction %>
                    <% end %>
                  </div>
                </div>

                <%# Secondary line with date, merchant, account info %>
                <div class="text-secondary text-xs font-normal">
                  <% if transaction.transfer? %>
                    <span class="text-secondary">
                      <%= transaction.loan_payment? ? t("transactions.show.loan_payment") : t("transactions.show.transfer") %> • <%= entry.account.name %>
                    </span>
                  <% else %>
                    <% if transaction.merchant&.present? %>
                      <span class="hidden lg:inline truncate"><%= transaction.merchant.name %> • </span>
                    <% end %>
                    <span class="text-secondary hidden lg:inline">
                      <%= link_to entry.account.name,
                          account_path(entry.account, tab: "transactions"),
                          data: { turbo_frame: "_top" },
                          class: "hover:underline" %>
                    </span>
                    <div class="flex items-center gap-1 truncate">
                      <%= render "categories/category_name_mobile", transaction: transaction %>
                      <% if transaction.merchant&.present? %>
                        <span class="lg:hidden truncate">• <%= transaction.merchant.name %></span>
                      <% end %>
                    </div>
                  <% end %>
                </div>
              </div>
            </div>
          <% end %>
        </div>
      </div>

      <div class="hidden md:flex flex-col items-center gap-1 col-span-2">
        <%= render "transactions/transaction_category", transaction: transaction, variant: "desktop" %>

        <%# Deferred to next billing cycle indicator - shows month name %>
        <% if transaction.deferred_to_next_billing_cycle? %>
          <span class="inline-flex items-center gap-1 text-xs font-medium rounded-full px-2 py-0.5 border border-yellow-500 bg-yellow-500/10 text-yellow-600" title="<%= t("transactions.transaction.deferred_tooltip") %>">
            <%= icon "calendar-clock", size: "sm", color: "current" %>
            <%= transaction.payment_due_date.strftime('%B') %>
          </span>
        <% end %>
      </div>

      <div class="shrink-0 col-span-4 lg:col-span-2 ml-auto text-right">
        <%= content_tag :p,
            transaction.transfer? && view_ctx == "global" ? "+/- #{format_money(entry.amount_money.abs)}" : format_money(-entry.amount_money),
            class: ["text-green-600": entry.amount.negative?] %>
      </div>
    </div>
  <% end %>
<% end %>
