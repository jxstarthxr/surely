<%# locals: (account:, url:) %>

<% if @error_message.present? %>
  <%= render DS::Alert.new(message: @error_message, variant: :error) %>
<% end %>

<div data-controller="favicon-preview">
<%= styled_form_with model: account, url: url, scope: :account, data: { turbo: false }, class: "flex flex-col gap-4 justify-between grow text-primary" do |form| %>
  <div class="grow space-y-2">
    <%= form.hidden_field :accountable_type %>
    <%= form.hidden_field :return_to, value: params[:return_to] %>

    <div class="flex flex-col items-center mb-4">
      <% if account.logo.attached? %>
        <div class="w-20 h-20 rounded-[22%] overflow-hidden flex items-center justify-center mb-3">
          <%= image_tag account.logo_image_url, class: "w-full h-full object-contain", alt: account.name %>
        </div>
      <% elsif account.logo_image_url.present? && (account.institution_domain.present? || account.provider&.logo_url.present?) %>
        <div class="w-20 h-20 rounded-[22%] overflow-hidden flex items-center justify-center mb-3">
          <img data-favicon-preview-target="preview" src="<%= account.logo_image_url %>" class="w-full h-full object-contain" alt="<%= account.name %>" />
        </div>
      <% else %>
        <div class="w-20 h-20 flex items-center justify-center relative mb-3">
          <img data-favicon-preview-target="preview" class="w-20 h-20 rounded-[22%] overflow-hidden object-contain opacity-0 absolute inset-0" alt="Logo preview" />
          <div data-favicon-preview-target="placeholder" class="flex items-center justify-center w-20 h-20 rounded-full" style="background-color: <%= account.accountable.color %>">
            <span class="text-3xl font-bold text-white"><%= account.name&.first&.upcase || '?' %></span>
          </div>
        </div>
      <% end %>

      <div class="flex gap-2">
        <%= form.file_field :logo, accept: "image/*", class: "hidden", id: "account_logo_upload" %>
        <label for="account_logo_upload" class="cursor-pointer px-3 py-1.5 text-sm bg-surface border border-primary rounded-lg hover:bg-surface-hover text-primary">
          <%= account.logo.attached? ? t(".change_logo") : t(".upload_logo") %>
        </label>
        <% if account.logo.attached? %>
          <%= button_tag type: "button", class: "px-3 py-1.5 text-sm bg-surface border border-primary rounded-lg hover:bg-surface-hover text-secondary", data: { action: "click->account-form#removeLogo" } do %>
            <%= t(".remove_logo") %>
          <% end %>
        <% end %>
      </div>
      <span class="text-xs text-subdued text-center mt-2"><%= t(".logo_hint") %></span>
      <div data-favicon-preview-target="warning" class="hidden mt-2 flex items-center gap-1 text-xs text-warning">
        <%= icon "alert-triangle", size: "sm" %>
        <span><%= t(".logo_fetch_failed") %></span>
      </div>
    </div>

    <%= form.text_field :name, placeholder: t(".name_placeholder"), required: "required", label: t(".name_label") %>

    <%= form.text_field :institution_name,
        label: t(".institution_name_label"),
        placeholder: account.provider&.institution_name || t(".institution_name_placeholder") %>

    <%= form.text_field :institution_domain,
        label: t(".institution_domain_label"),
        placeholder: account.provider&.institution_domain || t(".institution_domain_placeholder"),
        hint: t(".institution_domain_hint"),
        data: { favicon_preview_target: "input", action: "input->favicon-preview#handleInput" } %>

    <% unless account.linked? %>
      <%= form.money_field :balance, label: t(".balance"), required: true, default_currency: Current.family.currency %>
    <% end %>

    <%= yield form %>

    <details class="group">
      <summary class="cursor-pointer text-sm text-secondary hover:text-primary flex items-center gap-1 py-2">
        <%= icon "chevron-right", size: "sm", class: "group-open:rotate-90 transition-transform" %>
        <%= t(".additional_details") %>
      </summary>

      <div class="space-y-2 mt-2 pl-4 border-l border-primary">
        <%= form.text_area :notes,
            label: t(".notes_label"),
            placeholder: t(".notes_placeholder"),
            rows: 4 %>
      </div>
    </details>
  </div>

  <%= form.submit %>
<% end %>
</div>
