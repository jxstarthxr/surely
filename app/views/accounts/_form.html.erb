<%# locals: (account:, url:) %>

<% if @error_message.present? %>
  <%= render DS::Alert.new(message: @error_message, variant: :error) %>
<% end %>

<div data-controller="favicon-preview account-form">
<%= styled_form_with model: account, url: url, scope: :account, data: { turbo: false }, class: "flex flex-col gap-4 justify-between grow text-primary" do |form| %>
  <div class="grow space-y-2">
    <%= form.hidden_field :accountable_type %>
    <%= form.hidden_field :return_to, value: params[:return_to] %>

    <div class="flex flex-col items-center mb-4">
      <div class="flex items-center justify-center relative mb-3">
        <% if account.logo.attached? %>
          <div data-favicon-preview-target="existingLogo">
            <%= render "accounts/logo", account: account, size: "xl" %>
          </div>
          <div data-favicon-preview-target="placeholder" data-account-form-target="logoPlaceholder" class="flex items-center justify-center w-16 h-16 rounded-xl border-2 hidden" style="background-color: color-mix(in oklab, <%= account.accountable.color %> 10%, transparent); border-color: color-mix(in oklab, <%= account.accountable.color %> 10%, transparent); color: <%= account.accountable.color %>">
            <span class="text-xl font-medium uppercase"><%= account.name&.first&.upcase || '?' %></span>
          </div>
        <% else %>
          <% has_logo = account.provider&.logo_url.present? %>
          <div class="relative w-16 h-16">
            <div data-controller="adaptive-logo" data-adaptive-logo-target="container" class="w-16 h-16 rounded-xl overflow-hidden p-1 border-2 <%= 'opacity-0' unless has_logo %> absolute inset-0 flex items-center justify-center" style="background: linear-gradient(135deg, rgba(255,255,255,0.03) 0%, rgba(0,0,0,0.02) 100%); border-color: rgba(255,255,255,0.2);">
              <img data-favicon-preview-target="preview" data-adaptive-logo-target="image" src="<%= has_logo ? account.provider.logo_url : '' %>" class="w-full h-full object-contain rounded-md" alt="Logo preview" style="transform: scale(1);" />
            </div>
            <div data-favicon-preview-target="placeholder" data-account-form-target="logoPlaceholder" class="flex items-center justify-center w-16 h-16 rounded-xl border-2 <%= 'hidden' if has_logo %>" style="background-color: color-mix(in oklab, <%= account.accountable.color %> 10%, transparent); border-color: color-mix(in oklab, <%= account.accountable.color %> 10%, transparent); color: <%= account.accountable.color %>">
              <span class="text-xl font-medium uppercase"><%= account.name&.first&.upcase || '?' %></span>
            </div>
          </div>
        <% end %>
      </div>

      <div class="flex gap-2">
        <%= form.file_field :logo, accept: "image/*", class: "hidden", id: "account_logo_upload" %>
        <label for="account_logo_upload" class="cursor-pointer px-3 py-1.5 text-sm bg-surface border border-primary rounded-lg hover:bg-surface-hover text-primary">
          <%= account.logo.attached? ? t(".change_logo") : t(".upload_logo") %>
        </label>
        <% if account.logo.attached? %>
          <%= button_tag type: "button", class: "px-3 py-1.5 text-sm bg-surface border border-primary rounded-lg hover:bg-surface-hover text-secondary", data: { action: "click->account-form#removeLogo", account_form_target: "removeButton" } do %>
            <%= t(".remove_logo") %>
          <% end %>
        <% end %>
      </div>
      <span class="text-xs text-subdued text-center mt-2"><%= t(".logo_hint") %></span>
      <div data-favicon-preview-target="warning" class="hidden mt-2 flex items-center gap-1 text-xs text-warning">
        <%= icon "alert-triangle", size: "sm" %>
        <span><%= t(".logo_fetch_failed") %></span>
      </div>
    </div>

    <%= form.text_field :name, placeholder: t(".name_placeholder"), required: "required", label: t(".name_label") %>

    <%= form.text_field :institution_name,
        label: t(".institution_name_label"),
        placeholder: account.provider&.institution_name || t(".institution_name_placeholder") %>

    <%= form.text_field :institution_domain,
        label: t(".institution_domain_label"),
        placeholder: account.provider&.institution_domain || t(".institution_domain_placeholder"),
        hint: t(".institution_domain_hint"),
        data: { favicon_preview_target: "input", action: "input->favicon-preview#handleInput" } %>

    <% unless account.linked? %>
      <%= form.money_field :balance, label: t(".balance"), required: true, default_currency: Current.family.currency %>
    <% end %>

    <%= yield form %>

    <details class="group">
      <summary class="cursor-pointer text-sm text-secondary hover:text-primary flex items-center gap-1 py-2">
        <%= icon "chevron-right", size: "sm", class: "group-open:rotate-90 transition-transform" %>
        <%= t(".additional_details") %>
      </summary>

      <div class="space-y-2 mt-2 pl-4 border-l border-primary">
        <%= form.text_area :notes,
            label: t(".notes_label"),
            placeholder: t(".notes_placeholder"),
            rows: 4 %>
      </div>
    </details>
  </div>

  <%= form.submit %>
<% end %>
</div>
